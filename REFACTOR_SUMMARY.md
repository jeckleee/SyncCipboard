# ä»£ç é‡æ„æ€»ç»“

## ğŸ¯ é‡æ„ç›®æ ‡
ç®€åŒ–å‰ªè´´æ¿åŒæ­¥é€»è¾‘ï¼Œç§»é™¤ä¸å¿…è¦çš„ hash æ¯”è¾ƒæœºåˆ¶ï¼Œä½¿ç”¨ç®€å•çš„æ—¶é—´æˆ³ä¿æŠ¤æœŸæ¥é˜²æ­¢å¾ªç¯åŒæ­¥ã€‚

## âœ‚ï¸ ç§»é™¤çš„ä»£ç 

### å…¨å±€å˜é‡ï¼ˆå·²åˆ é™¤ï¼‰
- `last_clipboard_text` - ä¸å†éœ€è¦è·Ÿè¸ªä¸Šæ¬¡æ–‡æœ¬
- `last_clipboard_files` - ä¸å†éœ€è¦è·Ÿè¸ªä¸Šæ¬¡æ–‡ä»¶åˆ—è¡¨
- `last_clipboard_hash` - ä¸å†éœ€è¦è®¡ç®—å’Œæ¯”è¾ƒhash
- `last_received_hash` - ä¸å†éœ€è¦è·Ÿè¸ªæ¥æ”¶çš„hash
- `last_received_file` - ä¸å†éœ€è¦è·Ÿè¸ªæ¥æ”¶çš„æ–‡ä»¶
- `skip_next_clipboard_change` - ä¸å†éœ€è¦å¤æ‚çš„è·³è¿‡é€»è¾‘
- `watcher_pause_until` - å·²ç®€åŒ–ä¸º `last_sync_download_time`

### å‡½æ•°ï¼ˆå·²åˆ é™¤ï¼‰
- `is_same_file()` - ä¸å†éœ€è¦æ–‡ä»¶æ¯”è¾ƒ
- `get_image_hash()` - ä¸å†éœ€è¦å›¾ç‰‡å“ˆå¸Œè®¡ç®—
- `calculate_content_hash()` - ä¸å†éœ€è¦ç»Ÿä¸€å“ˆå¸Œè®¡ç®—

### æœåŠ¡å™¨å­—æ®µï¼ˆå·²åˆ é™¤ï¼‰
- `clipboard_store["content_hash"]` - æœåŠ¡å™¨ä¸å†å­˜å‚¨hash

## âœ¨ ä¿ç•™çš„æ ¸å¿ƒå˜é‡

```python
# å…¨å±€å˜é‡ï¼ˆä»…ä¿ç•™3ä¸ªï¼‰
last_sync_time = None              # æœåŠ¡å™¨çš„ updated_at
last_sync_download_time = 0        # æœ¬åœ°ä¸‹è½½æ—¶é—´æˆ³ï¼ˆç”¨äº3ç§’ä¿æŠ¤æœŸï¼‰
is_setting_clipboard = False       # æ­£åœ¨è®¾ç½®å‰ªè´´æ¿çš„æ ‡å¿—
stop_flag = False                  # çº¿ç¨‹åœæ­¢ä¿¡å·
```

## ğŸ”„ æ–°çš„åŒæ­¥é€»è¾‘

### çº¿ç¨‹1ï¼šä¸Šä¼ çº¿ç¨‹ (`clipboard_watcher`)
```python
while True:
    # ä¼˜å…ˆçº§1ï¼šæ­£åœ¨è®¾ç½®å‰ªè´´æ¿ï¼Ÿè·³è¿‡
    if is_setting_clipboard:
        sleep(0.3)
        continue
    
    # ä¼˜å…ˆçº§2ï¼šåœ¨ä¿æŠ¤æœŸå†…ï¼ˆ< 3ç§’ï¼‰ï¼Ÿè·³è¿‡
    if time.time() - last_sync_download_time < 3:
        sleep(0.5)
        continue
    
    # ä¼˜å…ˆçº§3ï¼šæ£€æµ‹å‰ªè´´æ¿å˜åŒ–
    current_files = get_clipboard_files()
    current_image = get_clipboard_image()
    current_text = pyperclip.paste()
    
    # ä½¿ç”¨å±€éƒ¨å˜é‡ (last_files, last_image_data, last_text) æ£€æµ‹å˜åŒ–
    if æœ‰å˜åŒ–:
        ä¸Šä¼ åˆ°æœåŠ¡å™¨
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨**å±€éƒ¨å˜é‡**ç¼“å­˜ä¸Šæ¬¡å†…å®¹ï¼Œåªåœ¨å‡½æ•°å†…éƒ¨æ¯”è¾ƒ
- ä¸å†ä½¿ç”¨å…¨å±€ hash æˆ–å…¨å±€ `last_clipboard_*`
- ä¾èµ– **3ç§’ä¿æŠ¤æœŸ** é˜²æ­¢å¾ªç¯ä¸Šä¼ 

### çº¿ç¨‹2ï¼šä¸‹è½½çº¿ç¨‹ (`sync_from_server`)
```python
while True:
    data = fetch_clipboard()
    if æœ‰æ–°å†…å®¹ and ä¸æ˜¯è‡ªå·±ä¸Šä¼ çš„:
        is_setting_clipboard = True
        
        # è®¾ç½®åˆ°å‰ªè´´æ¿
        if type == "image":
            tray_app.safe_set_image(image)
        elif type == "file":
            tray_app.safe_set_file(file_path)
        else:
            pyperclip.copy(text)
        
        # è®°å½•ä¸‹è½½æ—¶é—´ï¼ˆè§¦å‘ä¿æŠ¤æœŸï¼‰
        last_sync_download_time = time.time()
```

**å…³é”®ç‚¹**ï¼š
- ä¸‹è½½åç«‹å³è®°å½• `last_sync_download_time`
- `clipboard_watcher` ä¼šåœ¨æ¥ä¸‹æ¥çš„ 3 ç§’å†…è·³è¿‡æ‰€æœ‰ä¸Šä¼ 
- æ§½å‡½æ•° (`_set_image_to_clipboard`, `_set_file_to_clipboard`) è´Ÿè´£æ¸…é™¤ `is_setting_clipboard`

## ğŸ“Š ä»£ç è¡Œæ•°å¯¹æ¯”

| æ–‡ä»¶ | é‡æ„å‰ | é‡æ„å | å‡å°‘ |
|------|--------|--------|------|
| `client_gui.py` | ~857 è¡Œ | ~752 è¡Œ | ~105 è¡Œ |
| `server.py` | ~90 è¡Œ | ~87 è¡Œ | ~3 è¡Œ |

**æ€»è®¡å‡å°‘çº¦ 108 è¡Œä»£ç **

## ğŸš€ ä¼˜åŠ¿

1. **é€»è¾‘æ›´æ¸…æ™°**
   - ä¸å†æœ‰å¤æ‚çš„ hash è®¡ç®—å’Œæ¯”è¾ƒ
   - ä¸å†æœ‰å¤šå±‚ä¿æŠ¤æœºåˆ¶
   - åªæœ‰ä¸€ä¸ªç®€å•çš„æ—¶é—´æˆ³ä¿æŠ¤æœŸ

2. **æ€§èƒ½æ›´å¥½**
   - ç§»é™¤äº†å¤§é‡çš„ MD5 å“ˆå¸Œè®¡ç®—
   - ç§»é™¤äº†å›¾ç‰‡é‡æ–°è¯»å–å’Œç¼–ç æ“ä½œ
   - å‡å°‘äº†å…¨å±€å˜é‡çš„è¯»å†™

3. **æ›´æ˜“ç»´æŠ¤**
   - ä»£ç ç»“æ„æ›´ç®€å•
   - å‡å°‘äº†çŠ¶æ€åŒæ­¥çš„å¤æ‚æ€§
   - æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•

4. **æ›´å¯é **
   - ä¸ä¾èµ– hash æ˜¯å¦åŒ¹é…ï¼ˆç¼–ç å·®å¼‚é—®é¢˜ï¼‰
   - çº¯ç²¹çš„æ—¶é—´çª—å£ä¿æŠ¤
   - å‡å°‘äº†è¾¹ç•Œæƒ…å†µ

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æ–‡æœ¬åŒæ­¥**ï¼šå¤åˆ¶æ–‡æœ¬ â†’ æ£€æŸ¥æ˜¯å¦ä¸Šä¼  â†’ å¦ä¸€è®¾å¤‡æ¥æ”¶ â†’ ä¸åº”å†æ¬¡ä¸Šä¼ 
2. **å›¾ç‰‡åŒæ­¥**ï¼šæˆªå›¾ â†’ æ£€æŸ¥æ˜¯å¦ä¸Šä¼  â†’ å¦ä¸€è®¾å¤‡æ¥æ”¶ â†’ ä¸åº”å†æ¬¡ä¸Šä¼ 
3. **æ–‡ä»¶åŒæ­¥**ï¼šå¤åˆ¶æ–‡ä»¶ â†’ æ£€æŸ¥æ˜¯å¦ä¸Šä¼  â†’ å¦ä¸€è®¾å¤‡æ¥æ”¶ â†’ ä¸åº”å†æ¬¡ä¸Šä¼ 
4. **å¿«é€Ÿåˆ‡æ¢**ï¼š3ç§’å†…å¤šæ¬¡å¤åˆ¶ä¸åŒå†…å®¹ â†’ åº”è¯¥æ­£å¸¸ä¸Šä¼ 
5. **ä¿æŠ¤æœŸæµ‹è¯•**ï¼šæ¥æ”¶å†…å®¹åç«‹å³å¤åˆ¶æ–°å†…å®¹ â†’ 3ç§’ååº”è¯¥ä¸Šä¼ 

## ğŸ“ æ³¨æ„äº‹é¡¹

- `SYNC_PROTECTION_SECONDS = 3` æ˜¯å…³é”®å‚æ•°ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
- `is_setting_clipboard` ä»…ç”¨äºå¼‚æ­¥æ“ä½œï¼ˆimage/fileï¼‰ï¼Œæ–‡æœ¬æ˜¯åŒæ­¥çš„
- å±€éƒ¨å˜é‡ (`last_text`, `last_files`, `last_image_data`) ä»…åœ¨ `clipboard_watcher` å‡½æ•°å†…æœ‰æ•ˆ

